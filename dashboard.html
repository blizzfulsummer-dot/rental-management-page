<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Smart Home Admin Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --primary:#6366f1;--bg:#f4f6fb;--card:#fff;
  --text:#1f2937;--muted:#6b7280;--radius:18px;
}
*{box-sizing:border-box;font-family:Inter,system-ui}
body{margin:0;background:var(--bg);color:var(--text)}
header{background:#fff;padding:1rem 1.5rem;display:flex;justify-content:space-between;box-shadow:0 2px 12px rgba(0,0,0,.06)}
.role{background:#eef2ff;color:var(--primary);padding:.3rem .7rem;border-radius:999px}
main{max-width:1100px;margin:auto;padding:1.5rem}
.nav-back{cursor:pointer;color:var(--primary);margin-bottom:1rem}

/* Cards */
.card{background:#fff;border-radius:18px;padding:1.2rem;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem}

/* Toggle */
.toggle{width:42px;height:24px;background:#e5e7eb;border-radius:999px;position:relative;cursor:pointer}
.toggle::after{content:"";width:18px;height:18px;background:#fff;border-radius:50%;position:absolute;top:3px;left:3px;transition:.2s}
.toggle.active{background:var(--primary)}
.toggle.active::after{left:21px}

/* Stats */
.stats{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:2rem}
.stat{flex:1;min-width:160px;background:linear-gradient(135deg,#eef2ff,#fff);border-radius:18px;padding:1rem}
.stat strong{font-size:1.4rem}

/* Dashboard */
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.2rem}
.dashboard-card{background:#fff;padding:1.6rem;border-radius:18px;cursor:pointer;box-shadow:0 10px 25px rgba(0,0,0,.08)}
.dashboard-card:hover{transform:translateY(-4px)}

/* Charts */
.charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:1.5rem;margin-top:2rem}
.chart-card{background:#fff;padding:1.5rem;border-radius:18px}

/* Tables */
table{width:100%;border-collapse:collapse}
th,td{padding:.7rem;border-bottom:1px solid #e5e7eb;text-align:left}
th{background:#f9fafb}

/* Forms */
.form-card{max-width:520px;margin:auto;background:#fff;padding:2rem;border-radius:20px}
input,select,button{padding:.7rem;border-radius:12px;border:1px solid #e5e7eb}
button{cursor:pointer}
button.primary{background:var(--primary);color:#fff;border:none}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:99}
.modal{background:#fff;padding:1.5rem;border-radius:16px;width:320px}
.modal-buttons{display:flex;justify-content:flex-end;gap:.5rem}

footer{text-align:center;padding:1rem;color:var(--muted)}
</style>
</head>

<body>

<header>
  <h1>üè† ReMan</h1>
  <div class="role">Admin</div>
</header>

<main id="app"></main>

<div id="modal" class="modal-overlay">
  <div class="modal">
    <h3>Confirm</h3>
    <p id="modal-text"></p>
    <div class="modal-buttons">
      <button onclick="closeModal()">Cancel</button>
      <button class="primary" id="modal-ok">Delete</button>
    </div>
  </div>
</div>

<footer>¬© 2026 Smart Home & Rental Management</footer>

<script>
/* ================= STATE ================= */
const app = document.getElementById("app");

async function verifyUser() {
  const accessToken = localStorage.getItem("accessToken");
  const refreshToken = localStorage.getItem("refreshToken");

  if (!accessToken) {
    app.innerHTML = "<p style='color:red;'>No access token found. Please log in.</p>";
    return;
  }

  try {
    let res = await fetch(`${API_URL}/me`, {
      headers: { "Authorization": `Bearer ${accessToken}` }
    });

    if (res.ok) {
      const { user } = await res.json();
      app.innerHTML = `<p style="color:green;">User verified: ${user.name} (${user.role})</p>`;
    } else {
      const data = await res.json();
      app.innerHTML = `<p style="color:red;">Verification failed: ${data.error || res.status}</p>`;
    }
  } catch (err) {
    app.innerHTML = `<p style="color:red;">Network or server error: ${err.message}</p>`;
  }
}

// Run verification as soon as dashboard loads
verifyUser(); 

let homes=[
  {id:1,name:"Main House"},
  {id:2,name:"Beach Villa"}
];

let devices=[
  {id:1,homeId:1,name:"Living Room Light",pin:15},
  {id:2,homeId:2,name:"Pool Light",pin:4}
];

let tenants=[
  {id:1,name:"John Doe",email:"john@example.com",role:"Tenant", rent_amount:1000},
  {id:2,name:"Admin User",email:"admin@example.com",role:"Admin", rent_amount:2000}
];

let modalAction=null;

/* ================= MODAL ================= */
function openModal(msg,cb){
  document.getElementById("modal-text").textContent=msg;
  document.getElementById("modal").style.display="flex";
  modalAction=cb;
  document.getElementById("modal-ok").onclick=()=>{cb();closeModal();}
}
function closeModal(){
  document.getElementById("modal").style.display="none";
  modalAction=null;
}

/* ================= DASHBOARD ================= */
function renderDashboard(){
  app.innerHTML=`
    <div class="stats">
      <div class="stat"><span>Devices</span><strong>${devices.length}</strong></div>
      <div class="stat"><span>Tenants</span><strong>${tenants.length}</strong></div>
      <div class="stat"><span>Income</span><strong>‚Ç±4,500</strong></div>
    </div>

    <div class="dashboard-grid">
      <div class="dashboard-card" onclick="renderTenantForm()">Register Account</div>
      <div class="dashboard-card" onclick="renderTenantView()">View Accounts</div>
      <div class="dashboard-card" onclick="renderIOT()">Smart Home</div>
      <div class="dashboard-card" onclick="renderSettings()">Smart Settings</div>
    </div>

    <div class="charts">
      <div class="chart-card"><canvas id="pie"></canvas></div>
      <div class="chart-card"><canvas id="bar"></canvas></div>
    </div>
  `;
  new Chart(pie,{type:"pie",data:{labels:["Income","Expenses"],datasets:[{data:[4500,1800]}]}});
  new Chart(bar,{type:"bar",data:{labels:["Jan","Feb","Mar"],datasets:[
    {label:"Income",data:[4000,4300,4500]},
    {label:"Expenses",data:[1500,1700,1800]}
  ]}});
}

/* ================= IOT ================= */
function renderIOT(){
  app.innerHTML=`
    <div class="nav-back" onclick="renderDashboard()">‚Üê Back</div>
    <div class="grid">
      ${devices.map(d=>`
        <div class="card">
          <h3>${d.name}</h3>
          <div class="toggle active"></div>
        </div>`).join("")}
    </div>`;
}

/* ================= SETTINGS ================= */
function renderSettings(){
  app.innerHTML=`
    <div class="nav-back" onclick="renderDashboard()">‚Üê Back</div>

    <div class="card">
      <h3>Homes</h3>
      <table><tr><th>Name</th><th></th></tr>
      ${homes.map(h=>`
        <tr><td>${h.name}</td>
        <td>
            <button class="primary "onclick="renderEditHome(${h.id})">Edit</button>
            <button onclick="deleteHome(${h.id})">Delete</button></td></tr>`).join("")}
      </table>
      <input id="homeName" placeholder="Home name">
      <button class="primary" onclick="addHome()">Add</button>
    </div>

    <div class="card" style="margin-top:1rem">
      <h3>Devices</h3>
      <table><tr><th>Name</th><th>Pin</th><th></th></tr>
      ${devices.map(d=>`
        <tr><td>${d.name}</td><td>${d.pin}</td>
        <td>
            <button class="primary" onclick="renderEditDevice(${d.id})">Edit</button>
            <button onclick="deleteDevice(${d.id})">Delete</button></td></tr>`).join("")}
      </table>
      <select id="devHome">${homes.map(h=>`<option value="${h.id}">${h.name}</option>`)}</select>
      <input id="devName" placeholder="Device name">
      <input id="devPin" type="number" placeholder="Pin">
      <button class="primary" onclick="addDevice()">Add</button>
    </div>`;
}

function addHome(){
  const name=homeName.value.trim();
  if(!name)return;
  homes.push({id:Date.now(),name});
  renderSettings();
}
function addDevice(){
  devices.push({id:Date.now(),homeId:+devHome.value,name:devName.value,pin:+devPin.value});
  renderSettings();
}
function deleteHome(id){
  openModal("Delete home and its devices?",()=>{
    homes=homes.filter(h=>h.id!==id);
    devices=devices.filter(d=>d.homeId!==id);
    renderSettings();
  });
}
function deleteDevice(id){
  openModal("Delete device?",()=>{
    devices=devices.filter(d=>d.id!==id);
    renderSettings();
  });
}

/* ================= TENANTS ================= */
function renderTenantView() {
  app.innerHTML = `
    <div class="nav-back" onclick="renderDashboard()">‚Üê Back</div>
    <table class="tenant-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Rent</th>
          <th>Balance</th>
          <th>Onboard Date</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${tenants.map(t => `
          <tr>
            <td>${t.name}</td>
            <td>${t.email}</td>
            <td>${t.rent_amount ? "‚Ç±" + t.rent_amount : "-"}</td>
            <td>${t.balance ? "‚Ç±" + t.balance : "-"}</td>
            <td>${t.onboard_date || "-"}</td>
            <td>${t.role}</td>
            <td>
              <button class="primary" onclick="renderEditTenant(${t.id})">&nbsp;Edit &#9745;</button>
              <button onclick="deleteTenant(${t.id})">Delete</button>
            </td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
}

/*
function renderTenantView(){
  app.innerHTML=`
    <div class="nav-back" onclick="renderDashboard()">‚Üê Back</div>
    <table>
      <tr><th>Name</th><th>Email</th><th>Role</th><th></th></tr>
      ${tenants.map(t=>`
        <tr><td>${t.name}</td><td>${t.email}</td><td>${t.role}</td>
            
        <td><button class="primary" onclick="renderEditTenant(${t.id})">Edit</button>
            <button onclick="deleteTenant(${t.id})">Delete</button></td></tr>`).join("")}
    </table>`;
}*/

function renderTenantForm(){
  app.innerHTML = `
    <div class="nav-back" onclick="renderDashboard()">‚Üê Back</div>

    <div class="form-card">
      <h3>Register Account</h3>

      <!-- Role -->
      <div style="margin-bottom:1rem">
        <label>
          <input type="radio" name="role" value="Tenant" checked>
          Tenant
        </label>
        &nbsp;&nbsp;
        <label>
          <input type="radio" name="role" value="User">
          User
        </label>
         &nbsp;&nbsp;
        <label>
          <input type="radio" name="role" value="Admin">
          Admin
        </label>
      </div>

      <input id="tName" placeholder="Name">
      <input id="tEmail" placeholder="Email">

      <!-- Tenant-only fields (hidden by default) -->
      <div id="tenant-fields" style="display:none;margin-top:1rem">
        <input id="rent_amount" type="number" placeholder="Rent Amount">
        <input id="deposit" type="number" placeholder="Deposit">
        <input id="balance" type="number" placeholder="Balance" style="margin-top:.6rem">

        <label for="onboard_date" style="display:block;margin-top:.6rem;font-size:.85rem;color:#6b7280">&nbsp; On Board Date</label><input id="onboard_date" type="date">

        <div style="margin-top:.8rem">
          <small>Billing Cycle</small><br>
          <label>
            <input type="radio" name="billing_cycle" value="daily">
            Daily
          </label>
          &nbsp;
          <label>
            <input type="radio" name="billing_cycle" value="weekly">
            Weekly
          </label>
          &nbsp;
          <label>
            <input type="radio" name="billing_cycle" value="monthly" checked>
            Monthly
          </label>
        </div>
      </div>

      <button class="primary" onclick="addTenant()">Create</button>
    </div>
  `;

  setupRoleToggle();
}

function setupRoleToggle() {
  const radios = document.querySelectorAll('input[name="role"]');
  const tenantFields = document.getElementById("tenant-fields");

  const update = () => {
    const role = document.querySelector('input[name="role"]:checked')?.value;
    tenantFields.style.display = role === "Tenant" ? "block" : "none";
  };

  radios.forEach(r => r.addEventListener("change", update));

  update(); // üî• THIS is what you were missing
}


function addTenant() {
  const role = document.querySelector('input[name="role"]:checked')?.value;
  if (!role) return alert("Select role");

  const data = {
    id: Date.now(),
    name: tName.value,
    email: tEmail.value,
    role
  };

  if (role === "Tenant") {
    data.rent_amount = Number(rent_amount.value || 0);
    data.balance = Number(balance.value || 0);
    data.onboard_date = onboard_date.value;
    data.billing_cycle =
      document.querySelector('input[name="billing_cycle"]:checked')?.value || "monthly";
  }

  tenants.push(data);
  renderTenantView();
}

/*
function renderTenantForm(){
  app.innerHTML=`
    <div class="nav-back" onclick="renderDashboard()">‚Üê Back</div>
    <div class="form-card">
      <input id="tName" placeholder="Name">
      <input id="tEmail" placeholder="Email">
      <button class="primary" onclick="addTenant()">Create</button>
    </div>`;
}*/

function updateTenant(id){
  const tenant = tenants.find(t=>t.id===id);
  if(!tenant) return;

  tenant.name = editName.value.trim();
  tenant.email = editEmail.value.trim();
  tenant.role = editRole.value;

  renderTenantView();
}


function renderEditTenant(id){
  const tenant = tenants.find(t=>t.id===id);
  if(!tenant) return;

  app.innerHTML=`
    <div class="nav-back" onclick="renderTenantView()">‚Üê Back</div>

    <div class="form-card">
      <h3>Edit Account</h3>

      <input id="editName" value="${tenant.name}" placeholder="Name">
      <input id="editEmail" value="${tenant.email}" placeholder="Email">

      <select id="editRole">
        <option value="Tenant" ${tenant.role==="Tenant"?"selected":""}>Tenant</option>
        <option value="Admin" ${tenant.role==="Admin"?"selected":""}>Admin</option>
      </select>

      <div style="display:flex;gap:.5rem;margin-top:1rem">
        <button class="primary" onclick="updateTenant(${id})">Save</button>
        <button onclick="renderTenantView()">Cancel</button>
      </div>
    </div>
  `;
}


function addTenant(){
  tenants.push({id:Date.now(),name:tName.value,email:tEmail.value,role:"Tenant"});
  renderTenantView();
}
function deleteTenant(id){
  openModal("Delete tenant?",()=>{
    tenants=tenants.filter(t=>t.id!==id);
    renderTenantView();
  });
}

function renderEditHome(id){
  const home = homes.find(h=>h.id===id);
  if(!home) return;

  app.innerHTML = `
    <div class="nav-back" onclick="renderSettings()">‚Üê Back</div>

    <div class="form-card">
      <h3>Edit Home</h3>

      <input id="editHomeName" value="${home.name}" placeholder="Home Name">

      <div style="display:flex;gap:.5rem;margin-top:1rem">
        <button class="primary" onclick="updateHome(${id})">Save</button>
        <button onclick="renderSettings()">Cancel</button>
      </div>
    </div>
  `;
}

function updateHome(id){
  const home = homes.find(h=>h.id===id);
  if(!home) return;

  home.name = editHomeName.value.trim();
  renderSettings();
}


function renderEditDevice(id){
  const device = devices.find(d=>d.id===id);
  if(!device) return;

  app.innerHTML = `
    <div class="nav-back" onclick="renderSettings()">‚Üê Back</div>

    <div class="form-card">
      <h3>Edit Device</h3>

      <select id="editDeviceHome">
        ${homes.map(h=>`
          <option value="${h.id}" ${h.id===device.homeId?"selected":""}>
            ${h.name}
          </option>
        `).join("")}
      </select>

      <input id="editDeviceName" value="${device.name}" placeholder="Device Name">
      <input id="editDevicePin" type="number" value="${device.pin}" placeholder="Pin">

      <div style="display:flex;gap:.5rem;margin-top:1rem">
        <button class="primary" onclick="updateDevice(${id})">Save</button>
        <button onclick="renderSettings()">Cancel</button>
      </div>
    </div>
  `;
}

function updateDevice(id){
  const device = devices.find(d=>d.id===id);
  if(!device) return;

  device.homeId = Number(editDeviceHome.value);
  device.name = editDeviceName.value.trim();
  device.pin = Number(editDevicePin.value);

  renderSettings();
}




/* ================= TOGGLE ================= */
document.addEventListener("click",e=>{
  if(e.target.classList.contains("toggle"))e.target.classList.toggle("active");
});

/* INIT */
renderDashboard();
</script>
</body>
</html>
